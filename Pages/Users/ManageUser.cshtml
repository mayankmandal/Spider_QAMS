@page
@using System.Text.Json
@model Spider_QAMS.Pages.Users.ManageUserModel
@{
    ViewData["Title"] = "Manage Users";
    TempData["NavigationalPageName"] = "Manage User";
}

<div style="display:flex; flex-direction:column; align-items:center; min-height:20vh;">
    <div class="row pt-1 mb-3" style="width:100%;">
        <!-- Title on the left -->
        <div class="col text-start">
            <h4 class="rb-header">Manage Users</h4>
        </div>

        <!-- Buttons on the right -->
        <div class="col text-end">
            <button asp-page-handler="ExportToExcel" class="btn create-btn" style="background: linear-gradient(to bottom, #ffffff, #e0e0e0); color: #71797E;">
                <i class="fas fa-file-excel"></i>
                Export to Excel
            </button>
            <a asp-page="/Users/CreateUser" class="btn create-btn" style="background: linear-gradient(to bottom, #ffffff, #e0e0e0); color: #71797E;">
                <i class="fas fa-plus-circle"></i>
                &nbsp;Create New User
            </a>
        </div>
    </div>

    <div class="mb-3 mt-2 d-flex" style="justify-content: flex-start; width: 100%;">
        <label for="searchBy" class="me-2">Search by:</label>
        <select id="searchBy" class="form-select me-2" style="width:200px;">
            <option value="fullName">Name</option>
            <option value="emailId">Email</option>
            <option value="phoneNumber">Phone Number</option>
            <option value="designation">Designation</option>
            <option value="userName">Username</option>
        </select>
        <label for="searchInput" class="me-2">Search value:</label>
        <input type="text" id="searchInput" class="form-control me-2" style="width: 300px;" />

        <button type="button" class="btn btn-outline-secondary me-2" id="searchBtn">Search</button>
        <a href="javascript:void(0);" class="btn btn-link" id="resetBtn">Back to full list</a>
    </div>

    <div style="overflow-x:auto; max-height:40rem; width:100%;" class="mb-4">
        <table class="table table-bordered table-striped text-center">
            <thead class="table-header" style="background: linear-gradient(to bottom, #59636E, #6A7682); color: white;">
                <tr>
                    <th>Designation</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>User Name</th>
                    <th>Profile Name</th>
                    <th>Phone Number</th>
                    <th>Is Active</th>
                    <th>Is ADUser</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model.Users)
                {
                    <tr>
                        <td>@user.Designation</td>
                        <td>@user.FullName</td>
                        <td>@user.EmailID</td>
                        <td>@user.UserName</td>
                        <td>@user.ProfileSiteData.ProfileName</td>
                        <td>@user.PhoneNumber</td>
                        <td>
                            <input class="ms-1 form-check-input" type="checkbox" disabled="disabled" @(user.IsActive ? "checked" : "") style="position:relative;"/>
                        </td>
                        <td>
                            <input class="ms-1 form-check-input" type="checkbox" disabled="disabled" @(user.IsADUser ? "checked" : "") style="position:relative;" />
                        </td>
                        <td style="white-space: nowrap;">
                            <a asp-page="/Users/UpdateUser" asp-route-userId="@user.UserId" asp- class="btn btn-primary btn-sm"><i class="fas fa-edit"></i></a>
                            <a asp-page="/Users/DeleteUser" asp-route-userId="@user.UserId" class="btn btn-danger btn-sm"><i class="fas fa-trash-alt"></i></a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


@section scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        var usersData = @Html.Raw(JsonSerializer.Serialize(Model.Users));

        $(document).ready(function () {
            // Load the existing user data into the table on page load
            // updateTable(usersData);

            // Event handler for search button click
            $('#searchBtn').on('click', function () {
                filterUsers();
            });

            // Event handler for reset button click
            $('#resetBtn').on('click', function () {
                resetFilters();
            });

            // Function to filter users based on the search inputs
            function filterUsers() {
                // Get the selected search field and the input value
                var searchBy = $('#searchBy').val();
                var searchInput = $('#searchInput').val().toLowerCase();

                // Filter the user data
                var filteredUsers = $.grep(usersData, function (user) {
                    if (!searchInput) return true; // Show all users if searchInput is empty
                    return user[searchBy]?.toString().toLowerCase().includes(searchInput);
                });

                // Update the table with the filtered users
                updateTable(filteredUsers);
            }

            // Function to reset filters and display the full list
            function resetFilters() {
                // Reset input and dropdown to default values
                $('#searchInput').val('');
                $('#searchBy').prop('selectedIndex', 0);

                // Show the full user list
                updateTable(usersData);
            }

            // Function to dynamically update the table with user data
            function updateTable(users){
                var tbody = $('table tbody');
                tbody.empty(); // Clear the existing table content

                if (users.length === 0) {
                    // If no matching users are found, show a message
                    tbody.append('<tr><td colspan="9" class="text-center">No matching users found</td></tr>');
                    return;
                }

                // Loop through the user data and generate table rows
                $.each(users, function (index, user){
                    var row = `
                                <tr>
                                            <td>${user.Designation}</td>
                                            <td>${user.FullName}</td>
                                            <td>${user.EmailID}</td>
                                            <td>${user.UserName}</td>
                                                    <td>${user.ProfileSiteData.ProfileName}</td>
                                            <td>${user.PhoneNumber}</td>
                                    <td>
                                                <input class="ms-1 form-check-input" type="checkbox" disabled ${user.IsActive ? "checked" : ""} />
                                    </td>
                                    <td>
                                                <input class="ms-1 form-check-input" type="checkbox" disabled ${user.IsADUser ? "checked" : ""} />
                                    </td>
                                    <td style="white-space: nowrap;">
                                                <a href="/Users/UpdateUser?userId=${user.UserId}" class="btn btn-primary btn-sm"><i class="fas fa-edit"></i></a>
                                                <a href="/Users/DeleteUser?userId=${user.UserId}" class="btn btn-danger btn-sm"><i class="fas fa-trash-alt"></i></a>
                                    </td>
                                </tr>
                            `;
                    tbody.append(row); // Append the row to the table
                });
            }
        });
    </script>
}