@page
@model Spider_QAMS.Pages.ManageLocationsModel
@{
    ViewData["Title"] = "Manage Locations";
    TempData["NavigationalPageName"] = "Manage Locations";
}

<div style="display:flex; flex-direction:column; align-items:center; min-height:20vh;">
    <!-- Title and Action Buttons -->
    <div class="row pt-1 mb-3" style="width:100%;">
        <div class="col text-start">
            <h4 class="rb-header">Manage Locations</h4>
        </div>
        <div class="col text-end">
            <button class="btn create-btn" onclick="showCreateForm()" style="background: linear-gradient(to bottom, #ffffff, #e0e0e0); color: #71797E;">
                <i class="fas fa-plus-circle"></i>
                &nbsp;Create New Location
            </button>
        </div>
    </div>

    <div style="overflow-x:auto; max-height:20rem; width: 100%;" class="mb-4">
        <!-- Table: List of Existing Locations -->
        <table class="table table-bordered table-striped text-center">
            <thead class="table-header" style="background: linear-gradient(to bottom, #59636E, #6A7682); color: white;">
                <tr>
                    <th>Location</th>
                    <th>Street Name</th>
                    <th>City</th>
                    <th>Region</th>
                    <th>Sponsor</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var location in Model.LocationVMs)
                {
                    <tr>
                        <td>@location.Location</td>
                        <td>@location.StreetName</td>
                        <td>@location.CityName</td>
                        <td>@location.RegionName</td>
                        <td>@location.SponsorName</td>
                        <td style="white-space: nowrap;">
                            <!-- Edit Button -->
                            <button type="button" class="btn btn-primary btn-sm" onclick="showEditForm('@location.LocationId', '@location.Location', '@location.StreetName', '@location.CityId', '@location.RegionId', '@location.BranchName','@location.DistrictName','@location.SponsorId')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <!-- Delete Button -->
                            <button type="button" class="btn btn-danger btn-sm" onclick="showDeleteForm('@location.LocationId', '@location.Location', '@location.StreetName', '@location.CityId', '@location.RegionId', '@location.RegionName','@location.BranchName','@location.DistrictName','@location.CityId', '@location.CityName','@location.SponsorId','@location.SponsorName')">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Create New Location Form (Hidden Initially) -->
    <div id="createFormDiv" style="display:none; flex-direction: column; align-items: center; min-height: 20vh;">
        <form method="post" asp-page-handler="Create" id="createLocationForm">
            <div class="container form-control border-2 mb-2" style="display:flex; justify-content:space-around; height:auto; flex-direction:column;width: 45rem;">
                <div class="row pb-1 pt-2">
                    <div style="color:#17a2b8; text-align:center; font-size:1.7rem; font-weight:500">CREATE NEW LOCATION</div>
                    <div><hr /></div>
                </div>
                <div class="card">
                    <div class="card-header" style="background:#f8f8f8;">
                        <div class="card-title fw-bold" style="font-size:1.2rem">Location Details</div>
                    </div>
                    <div class="card-body">
                        <!-- Validation Summary -->
                        <div asp-validation-summary="All" class="text-danger fw-bold"></div>

                        <!-- Location Field -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.Location" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.Location" placeholder="Location" class="form-control" />
                            </div>
                            <span asp-validation-for="siteLocationVM.Location" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Street Name Field -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.StreetName" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-road"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.StreetName" placeholder="Street Name" class="form-control" />
                            </div>
                            <span asp-validation-for="siteLocationVM.StreetName" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Region Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.RegionId" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-globe"></i></span>
                                </div>
                                <select id="regionSelect" asp-for="siteLocationVM.RegionId" class="form-select striped-select" required onchange="loadCities(this.value, null, 'create')">
                                    <option value="" disabled selected>--Select Region--</option>
                                    @foreach (var region in Model.RegionAssociatedCitiesLst)
                                    {
                                        <option value="@region.RegionId">@region.RegionName</option>
                                    }
                                </select>
                            </div>
                            <span asp-validation-for="siteLocationVM.RegionId" class="text-danger fw-bold"></span>
                        </div>

                        <!-- City Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.CityId" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-city"></i></span>
                                </div>
                                <select id="createCitySelect" asp-for="siteLocationVM.CityId" class="form-select striped-select" required>
                                    <option value="" disabled selected>--Select City--</option>
                                    <!-- Cities will be loaded here based on the selected region -->
                                </select>
                            </div>
                            <span asp-validation-for="siteLocationVM.CityId" class="text-danger fw-bold"></span>
                        </div>

                        <!-- District Name Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.DistrictName" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-building"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.DistrictName" placeholder="District Name" class="form-control" />
                            </div>
                            <span asp-validation-for="siteLocationVM.DistrictName" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Branch Name Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.BranchName" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-map-signs"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.BranchName" placeholder="Branch Name" class="form-control" />
                            </div>
                            <span asp-validation-for="siteLocationVM.BranchName" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Sponsor Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.SponsorId" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-handshake"></i></span>
                                </div>
                                <select id="sponsorSelect" asp-for="siteLocationVM.SponsorId" class="form-select striped-select" required>
                                    <option value="" disabled selected>--Select Sponsor--</option>
                                    @foreach (var sponsor in Model.Sponsors)
                                    {
                                        <option value="@sponsor.SponsorId">@sponsor.SponsorName</option>
                                    }
                                </select>
                            </div>
                            <span asp-validation-for="siteLocationVM.SponsorId" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Buttons for form submission -->
                        <div style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
                            <div class="row" style="width: 100%; max-width: 600px; display: flex; justify-content: space-around;">
                                <button type="submit" class="btn create-btn">Create Location</button>
                                <button type="button" class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Edit Location Form (Hidden Initially) -->
    <div id="editFormDiv" style="display:none; flex-direction: column; align-items: center; min-height: 20vh;">
        <form method="post" asp-page-handler="Update">
            <input type="hidden" asp-for="siteLocationVM.LocationId" id="editLocationId" />
            <div class="container form-control border-2 mb-2" style="display:flex; justify-content:space-around; height:auto; flex-direction:column;width: 45rem;">
                <div class="row pb-1 pt-2">
                    <div style="color:#17a2b8; text-align:center; font-size:1.7rem; font-weight:500">EDIT LOCATION</div>
                    <div><hr /></div>
                </div>
                <div class="card">
                    <div class="card-header" style="background:#f8f8f8;">
                        <div class="card-title fw-bold" style="font-size:1.2rem">Location Details</div>
                    </div>
                    <div class="card-body">
                        <!-- Validation Summary -->
                        <div asp-validation-summary="All" class="text-danger fw-bold"></div>

                        <!-- Location Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.Location" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.Location" placeholder="Location" class="form-control" id="editLocationName" />
                            </div>
                            <span asp-validation-for="siteLocationVM.Location" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Street Name Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.StreetName" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-road"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.StreetName" placeholder="Street Name" class="form-control" id="editStreetName" />
                            </div>
                            <span asp-validation-for="siteLocationVM.StreetName" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Region Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.RegionId" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-globe"></i></span>
                                </div>
                                <select id="editRegionId" asp-for="siteLocationVM.RegionId" class="form-select striped-select" required onchange="loadCities(this.value, null, 'edit')">
                                    <option value="" disabled>--Select Region--</option>
                                    @foreach (var region in Model.RegionAssociatedCitiesLst)
                                    {
                                        <option value="@region.RegionId">@region.RegionName</option>
                                    }
                                </select>
                            </div>
                            <span asp-validation-for="siteLocationVM.RegionId" class="text-danger fw-bold"></span>
                        </div>

                        <!-- City Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.CityId" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-city"></i></span>
                                </div>
                                <select id="editCitySelect" asp-for="siteLocationVM.CityId" class="form-select striped-select" required>
                                    <option value="" disabled selected>--Select City--</option>
                                    <!-- Cities will be loaded here based on the selected region -->
                                </select>
                            </div>
                            <span asp-validation-for="siteLocationVM.CityId" class="text-danger fw-bold"></span>
                        </div>

                        <!-- District Name Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.DistrictName" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-building"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.DistrictName" placeholder="District Name" class="form-control" id="editDistrictName" />
                            </div>
                            <span asp-validation-for="siteLocationVM.DistrictName" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Branch Name Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.BranchName" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-map-signs"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.BranchName" placeholder="Branch Name" class="form-control" id="editBranchName" />
                            </div>
                            <span asp-validation-for="siteLocationVM.BranchName" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Sponsor Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.SponsorId" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-handshake"></i></span>
                                </div>
                                <select id="editSponsorId" asp-for="siteLocationVM.SponsorId" class="form-select striped-select" required>
                                    <option value="" disabled selected>--Select Sponsor--</option>
                                    @foreach (var sponsor in Model.Sponsors)
                                    {
                                        <option value="@sponsor.SponsorId">@sponsor.SponsorName</option>
                                    }
                                </select>
                            </div>
                            <span asp-validation-for="siteLocationVM.SponsorId" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Buttons for form submission -->
                        <div style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
                            <div class="row" style="width: 100%; max-width: 600px; display: flex; justify-content: space-around;">
                                <button type="submit" class="btn update-btn">Update Location</button>
                                <button type="button" class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Delete Location Form (Hidden Initially) -->
    <div id="deleteFormDiv" style="display:none; flex-direction: column; align-items: center; min-height: 20vh;">
        <form method="post" asp-page-handler="Delete">
            <input type="hidden" asp-for="siteLocationVM.LocationId" id="deleteLocationId" name="LocationId" />
            <div class="container form-control border-2 mb-2" style="display:flex; justify-content:space-around; height:auto; flex-direction:column;width: 45rem;">
                <div class="row pb-1 pt-2">
                    <div style="color:#dc3545; text-align:center; font-size:1.5rem; font-weight:500">DELETE LOCATION</div>
                    <div><hr /></div>
                </div>
                <div class="card">
                    <div class="card-header" style="background:#f8f8f8;">
                        <div class="card-title fw-bold" style="font-size:1.2rem">Are you sure you want to delete this location?</div>
                    </div>
                    <div class="card-body">

                        <!-- Validation Summary -->
                        <div asp-validation-summary="All" class="text-danger fw-bold"></div>

                        <!-- Location Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.Location" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.Location" placeholder="Location" class="form-control" id="deleteLocationName" disabled/>
                            </div>
                            <span asp-validation-for="siteLocationVM.Location" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Street Name Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.StreetName" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-road"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.StreetName" placeholder="Street Name" class="form-control" id="deleteStreetName" disabled />
                            </div>
                            <span asp-validation-for="siteLocationVM.StreetName" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Region Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.RegionId" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-globe"></i></span>
                                </div>
                                <select id="deleteRegionId" asp-for="siteLocationVM.RegionId" class="form-select striped-select" required onchange="loadCities(this.value, null, 'edit')">
                                    <option value="" disabled>--Select Region--</option>
                                    <!-- Regions will be loaded here -->
                                </select>
                            </div>
                            <span asp-validation-for="siteLocationVM.RegionId" class="text-danger fw-bold"></span>
                        </div>

                        <!-- City Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.CityId" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-city"></i></span>
                                </div>
                                <select id="deleteCitySelect" asp-for="siteLocationVM.CityId" class="form-select striped-select" required>
                                    <option value="" disabled selected>--Select City--</option>
                                    <!-- Cities will be loaded here based on the selected region -->
                                </select>
                            </div>
                            <span asp-validation-for="siteLocationVM.CityId" class="text-danger fw-bold"></span>
                        </div>

                        <!-- District Name Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.DistrictName" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-building"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.DistrictName" placeholder="District Name" class="form-control" id="deleteDistrictName" disabled/>
                            </div>
                            <span asp-validation-for="siteLocationVM.DistrictName" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Branch Name Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.BranchName" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-map-signs"></i></span>
                                </div>
                                <input asp-for="siteLocationVM.BranchName" placeholder="Branch Name" class="form-control" id="deleteBranchName" disabled/>
                            </div>
                            <span asp-validation-for="siteLocationVM.BranchName" class="text-danger fw-bold"></span>
                        </div>

                        <!-- Sponsor Field with Icon -->
                        <div class="mb-3">
                            <label asp-for="siteLocationVM.SponsorId" class="form-label"></label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-handshake"></i></span>
                                </div>
                                <select id="deleteSponsorId" asp-for="siteLocationVM.SponsorId" class="form-select striped-select" required>
                                    <option value="" disabled selected>--Select Sponsor--</option>
                                    <!-- Sponsors will be loaded here -->
                                </select>
                            </div>
                            <span asp-validation-for="siteLocationVM.SponsorId" class="text-danger fw-bold"></span>
                        </div>

                        <p class="text">Are you sure you want to delete location <strong id="deleteLocationName"></strong>?</p>

                        <!-- Buttons for deletion confirmation -->
                        <div style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
                            <div class="row" style="width: 100%; max-width: 600px; display: flex; justify-content: space-around;">
                                <button type="submit" class="btn delete-btn">Confirm Delete</button>
                                <button type="button" class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        var regionData = @Html.Raw(Json.Serialize(Model.RegionAssociatedCitiesLst));

        function showCreateForm() {
            hideAllForms();
            $("#createFormDiv").css("display", "flex");
        }

        function showEditForm(locationId, locationName, streetName, cityId, regionId, branchName, districtName, sponsorId) {
            hideAllForms();
            $("#editFormDiv").css("display", "flex");

            $("#editLocationId").val(locationId);
            $("#editLocationName").val(locationName);
            $("#editStreetName").val(streetName);
            $("#editBranchName").val(branchName);
            $("#editDistrictName").val(districtName);

            // Set region dropdown and trigger city load
            $("#editRegionId").val(regionId);

            $("#editSponsorId").val(sponsorId);

            // Load cities for the selected region and set the city value after cities are loaded
            loadCities(regionId, cityId, 'edit'); // Pass cityId to select it later
        }

        function showDeleteForm(locationId, locationName, streetName, cityId, regionId, regionName, branchName, districtName, cityId, cityName, sponsorId, sponsorName) {
            hideAllForms();
            $("#deleteFormDiv").css("display", "flex");
            $("#deleteLocationId").val(locationId);
            $("#deleteLocationName").val(locationName);
            $("#deleteStreetName").val(streetName);
            $("#deleteBranchName").val(branchName);
            $("#deleteDistrictName").val(districtName);

            // Set region dropdown and trigger city load
            $('#deleteRegionId').empty().append(new Option(regionName, regionId)).prop('disabled', true); // Set and disable the dropdown
            $('#deleteCitySelect').empty().append(new Option(cityName, cityId)).prop('disabled', true); // Set and disable the dropdown
            $('#deleteSponsorId').empty().append(new Option(sponsorName, sponsorId)).prop('disabled', true); // Set and disable the dropdown
        }

        function hideAllForms() {
            $("#createFormDiv").css("display", "none");
            $("#editFormDiv").css("display", "none");
            $("#deleteFormDiv").css("display", "none");
        }

        // Function to load cities and optionally select a city
        function loadCities(regionId, selectedCityId = null, formType = "create") {
            // Determine which city select element to target based on form type
            var citySelectId = formType === "edit" ? '#editCitySelect' : '#createCitySelect';

            // Clear the current city options
            $(citySelectId).empty();
            $(citySelectId).append('<option value="" disabled selected>--Select City--</option>');

            // Find the selected region's cities from regionData
            var selectedRegion = regionData.find(r => r.regionId == parseInt(regionId));

            // Check if selectedRegion has cities
            if (selectedRegion && selectedRegion.cities) {
                // Add cities to the city dropdown
                selectedRegion.cities.forEach(function (city) {
                    $(citySelectId).append(`<option value="${city.cityId}">${city.cityName}</option>`);
                });
            }
            // If there's a city to be selected, set it after cities are loaded
            if (selectedCityId) {
                $(citySelectId).val(selectedCityId);
            }
        }
    </script>
}